<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel Administrativo – UpLife</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      background: #f7f7f7;
    }
    header {
      background: #f78c1e;
      color: #fff;
      padding: 1rem;
      text-align: center;
    }
    main {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 1rem;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1 { margin-top: 0; }
    form { display: grid; gap: 1rem; margin-bottom: 2rem; }
    input, textarea, select, button { padding: 0.5rem; font-size: 1rem; width: 100%; }
    button { cursor: pointer; background: #f78c1e; color: #fff; border: none; border-radius: 5px; }
    .vaga { border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 5px; background: #fafafa; }
    .vaga button { width: auto; margin-right: 0.5rem; }
  </style>
</head>
<body>
  <header>
    <h1>Painel Administrativo – UpLife</h1>
  </header>
  <main>
    <form id="formVaga">
      <input type="text" name="titulo" placeholder="Título da vaga" required>
      <input type="text" name="empresa" placeholder="Empresa">
      <input type="text" name="funcao" placeholder="Função">
      <input type="text" name="local" placeholder="Local">
      <input type="text" name="area" placeholder="Área">
      <textarea name="descricao" placeholder="Descrição"></textarea>
      <input type="text" name="link" placeholder="Link da vaga">
      <label>
        <input type="checkbox" name="tecnicoCompetencia"> Técnico por Competência
      </label>
      <h3>Curso relacionado</h3>
      <input type="text" name="cursoNome" placeholder="Nome do curso">
      <input type="text" name="cursoDescricao" placeholder="Descrição do curso">
      <input type="text" name="cursoImagem" placeholder="URL da imagem do curso">
      <input type="text" name="cursoLink" placeholder="Link do curso">
      <button type="submit">Salvar Vaga</button>
    </form>

    <div id="listaVagas"></div>
  </main>

  <script>
    let vagaEditando = null;

    // Função para carregar vagas
    async function carregarVagas() {
      try {
        const res = await fetch('/api/vagas');
        const text = await res.text();
        let vagas;
        try {
          vagas = JSON.parse(text);
        } catch(err) {
          console.error("Erro ao interpretar JSON:", err, text);
          vagas = [];
        }

        const lista = document.getElementById('listaVagas');
        lista.innerHTML = '';
        vagas.forEach(v => {
          const div = document.createElement('div');
          div.className = 'vaga';
          div.innerHTML = `
            <strong>${v.titulo ?? ''}</strong><br>
            Empresa: ${v.empresa ?? ''}<br>
            Função: ${v.funcao ?? ''}<br>
            Local: ${v.local ?? ''}<br>
            Área: ${v.area ?? ''}<br>
            Descrição: ${v.descricao ? (v.descricao.length > 100 ? v.descricao.substring(0,100) + '...' : v.descricao) : ''}<br>
            <a href="${v.link ?? '#'}" target="_blank">Ver Link</a><br>
            <button class="btn-excluir" onclick="excluirVaga(${v.id})">Excluir</button>
            <button class="btn-editar" onclick='editarVaga(${JSON.stringify(v).replace(/'/g,"\\'")})'>Editar</button>
          `;
          lista.appendChild(div);
        });
      } catch(e) { console.error(e); }
    }

    // Função para editar vaga
    function editarVaga(vaga){
      const f = document.getElementById('formVaga');
      f.titulo.value = vaga.titulo ?? '';
      f.empresa.value = vaga.empresa ?? '';
      f.funcao.value = vaga.funcao ?? '';
      f.local.value = vaga.local ?? '';
      f.area.value = vaga.area ?? '';
      f.descricao.value = vaga.descricao ?? '';
      f.link.value = vaga.link ?? '';
      f.tecnicoCompetencia.checked = vaga.tecnicoCompetencia ?? false;
      if(vaga.curso){
        f.cursoNome.value = vaga.curso.nome ?? '';
        f.cursoDescricao.value = vaga.curso.descricao ?? '';
        f.cursoImagem.value = vaga.curso.imagem ?? '';
        f.cursoLink.value = vaga.curso.link ?? '';
      } else {
        f.cursoNome.value = '';
        f.cursoDescricao.value = '';
        f.cursoImagem.value = '';
        f.cursoLink.value = '';
      }
      vagaEditando = vaga.id ?? null;
      window.scrollTo({top:0, behavior:'smooth'});
    }

    // Função para excluir vaga
    async function excluirVaga(id){
      if(!confirm('Deseja realmente excluir esta vaga?')) return;
      try{
        await fetch(`/api/vagas/${id}`, { method: 'DELETE' });
        carregarVagas();
      } catch(e) { console.error(e); }
    }

    // Submissão do formulário
    document.getElementById('formVaga').addEventListener('submit', async e=>{
      e.preventDefault();
      const f = e.target;
      const vagaData = {
        titulo: f.titulo.value,
        empresa: f.empresa.value,
        funcao: f.funcao.value,
        local: f.local.value,
        area: f.area.value,
        descricao: f.descricao.value,
        link: f.link.value,
        tecnicoCompetencia: f.tecnicoCompetencia.checked,
        curso: {
          nome: f.cursoNome.value,
          descricao: f.cursoDescricao.value,
          imagem: f.cursoImagem.value,
          link: f.cursoLink.value
        }
      };
      try{
        if(vagaEditando){
          await fetch(`/api/vagas/${vagaEditando}`, {
            method: 'PUT',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(vagaData)
          });
        } else {
          await fetch('/api/vagas', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(vagaData)
          });
        }
        f.reset();
        vagaEditando = null;
        carregarVagas();
      } catch(e){ console.error(e); }
    });

    carregarVagas();
  </script>
</body>
</html>
